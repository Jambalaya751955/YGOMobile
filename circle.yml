machine:
  environment:
    ANDROID_HOME: /usr/local/android-sdk-linux
    QUALITY: 100


dependencies:
  cache_directories:
    - /usr/local/android-sdk-linux
    - ~/.gradle
    - ~/.android
    - android-ndk-r15b
    - .gradle
    - .idea
    - mobile/build
    - libcore/build
    - libcore/libs
    - libcore/obj
  override:
    - sudo -E apt-get -yq update
    - sudo -E apt-get -yq --no-install-suggests --no-install-recommends --force-yes install imagemagick p7zip-full

    - echo y | android update sdk --no-ui --all --filter "platform-tools"
    - echo y | android update sdk --no-ui --all --filter "tools"
    - echo y | android update sdk --no-ui --all --filter "build-tools-26.0.0"
    - echo y | android update sdk --no-ui --all --filter "android-26"
    - echo y | android update sdk --no-ui --all --filter "extra-google-m2repository"
    - echo y | android update sdk --no-ui --all --filter "extra-android-m2repository"
    - cp -rf tools/licenses $ANDROID_HOME

    - chmod 777 ./gradlew

    - if [[ ! -f "android-ndk-r15b/ndk-build" ]]; then  
        curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://dl.google.com/android/repository/android-ndk-r15b-linux-x86_64.zip;
        7z x -y android-ndk-r15b-linux-x86_64.zip > /dev/null;
      fi

    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/purerosefallen/ygopro-core/archive/master.zip
    - 7z x -y ygopro-core-master.zip > /dev/null
    - cp -rf ygopro-core-master/* Classes/ocgcore/

    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/purerosefallen/ygopro-7210srv/raw/master/strings.conf
    - mv -f strings.conf mobile/assets/data/conf

    - mkdir script
    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/Fluorohydride/ygopro-scripts/raw/master/constant.lua
    - mv -f constant.lua script
    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/Fluorohydride/ygopro-scripts/raw/master/utility.lua
    - mv -f utility.lua script

    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/HuangYuNan/thcsvr/archive/master.zip
    - 7z x thcsvr-master.zip > /dev/null
    - cp -rf thcsvr-master/ocgcore Classes
    - mv -f thcsvr-master/expansions/thc.cdb cards.cdb
    - cp -rf cards.cdb mobile/assets/data
    - cp -rf thcsvr-master/expansions/script/*.lua script
    - rm -rf thcsvr-master/expansions/script/*.lua
    - cp -rf thcsvr-master/lflist.conf mobile/assets/data/conf

    - rm -rf thcsvr-master/expansions/pics/thumbnail
    - rm -rf thcsvr-master/expansions/pics/*.db
    - mv -f thcsvr-master/expansions/pics .

    - cp -rf thcsvr-master/expansions mobile/assets/data

    - rm -rf pics/thumbnail pics/*.db
    - cd pics && ls *.jpg | xargs -I {} -P 4 convert -size 177x254! -quality $QUALITY {} {} && cd ..

    - 7z a -mx0 mobile/assets/data/pics.zip pics > /dev/null
    - 7z a -mx0 mobile/assets/data/scripts.zip script > /dev/null

    - curl --retry 5 --connect-timeout 30 --location --remote-header-name --remote-name https://github.com/purerosefallen/ygopro-7210srv/raw/master/strings.conf
    - mv -f strings.conf mobile/assets/data/conf


    - cp -rf tools/Application.mk libcore/jni
    - cp -rf tools/*.png mobile/src/main/res/drawable

    - cd libcore && ./../android-ndk-r15b/ndk-build -j8 && cd ..

test:
  override:
    - ./gradlew :mobile:assembleMycardRelease

    - find . -name *.lock -print | xargs -I {} -P 4 rm -rf {}
    - find ~/.gradle -name *.lock -print | xargs -I {} -P 4 rm -rf {}
    - find ~/.android -name *.lock -print | xargs -I {} -P 4 rm -rf {}

  post:
    - mv -f mobile/build/outputs/apk/mobile-mycard-armeabi-v7a-release.apk $CIRCLE_ARTIFACTS/ygomobile-$CIRCLE_BRANCH.apk
